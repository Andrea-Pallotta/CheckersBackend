# Connect 4 WebSockets API

## Overview

This WebSockets API was created as the final project for ISTE-442. It's responsible for handling all the logic for the Connect 4 ReactJS App.

## Pre-requisites

- NodeJS `16.x.x`.
- npm `8.x.x` or later.
- latest `ubuntu`, `macOS`, `windows 10.x.x`.

# How to configure and run the server

1. Clone the project locally `git clone git@github.com:Andrea-Pallotta/Connect4Backend.git`.
2. To run the code in your local environment, execute `npm run start:dev`.
3. You won't be able to run `npm start` because it's solely used for the server on the EC2 instance.
   - You can modify the IP used by `npm start` in the file [./configs/configs.js](configs/configs.js#L6).
   - If you modify the IP, make sure to modify the `EC2` IP in the frontend at [Connect4Frontend/connect4/src/components/API/endpoints.js](https://github.com/Andrea-Pallotta/Connect4Frontend/blob/main/connect4/src/components/API/endpoints.js#L5).
   - It may create problems if not done correctly. Not modifying IP addresses is recommended!

# How CI/CD works

- The `./.github/workflows/ci-cd.yml` contains all the CI/CD jobs.
- The server is deployed on the EC2 when there is a `pull_request` to `[ main ]`.
- The pipelines use AWS CodeDeploy to handle the logic behind CD.
- On the EC2 instance, AWS CodeDeploy uses the ecosystem.json to start a pm2 daemon.
- The Load Balancer starts hitting the health check endpoint. After 7 successful requests (response code `200`), the server will be available.
- A nginx instance runs on the EC2 on port 80 and acts as a proxy (or reverse proxy) for HTTP requests on port 80. Required by the Load Balancer.

## Architecture and Features

- The ExpressJS server runs on port 8081 (Make sure it's unused when running the project locally!) and a Socket.io (WebSockets) server on top of it.
- The ExpressJS API acts as a business logic layer to communicate with the SQLite database.
- The Socket.io API, instead, uses local resources stored in the server memory to handle real time events.
- The benefit of using both local resources and a DB is:
  - Both horizontal and vertical scalabilty.
  - Avoid overloading one or the other resource.
  - Performance: the Socket.io API has been developed so that in-memory unused resources are automatically deleted (i.e. games, socket connections, etc...).
- Every HTTP and WS request is validated using JWTs. Redirecting to 401/403 Errors is the default behavior.
  - JWTs are embedded in the HTTP header as Bearer authorization tokens.
  - Since the JWTs are generated by AWS Cognito, the JWT validation is done by an AWS-approved library implemented as a middleware.
- CORS are configured for the ExpressJS server (WS doesn't care about CORS).
- The SQLite3 database is hosted locally. Its content is binary and not readable by humans. An SQL file is used as migration template:
  - It contains the `CREATE TABLE` and `DROP TABLE` queries.
  - If the SQLite3 database files are deleted, it autogenerates the tables (not configured to repopulate data).
- ExpressJS requests are validated using aJv and custom payloads.

## Code Structure

- The code is divided into classes to respect the "Separation of Concerns" Design Principle.
- Extensive use of `ES6 Classes` to handle same data types instead of using plain JSON Objects.
- Environment variables are grouped in a JSON object to be reused throughout the application.
- The code contains one Array property extension.
- Maps/Sets are serialized with a custom function before being sent to the frontend via WS.

## HTTPS/WSS

- The server itself runs on `HTTP` and `WS`.
- An AWS Application Load Balancer (`ALB`) is attached to the EC2 instance on which the server runs and acts as a "Man in the Middle".
  - When the ReactJS frontend hosted on AWS Amplify sends a secure (`HTTPS/WSS`) request to the server, the ALB
    redirects the requests to port `8081` as unsecure requests. This process is called `SSL Termination`.
  - Only the connection between the frontend and the ALB uses SSL/TLS.
- The ALB is not scalable because it only uses free features.

# Project Dependencies

## Dependencies

- [aws-jwt-verify](https://github.com/awslabs/aws-jwt-verify)
- [cors](https://github.com/expressjs/cors)
- [cross-env](https://github.com/kentcdodds/cross-env)
- [dotenv](https://github.com/motdotla/dotenv)
- [express](https://github.com/expressjs/express)
- [mongoose](https://github.com/Automattic/mongoose)
- [socket.io](https://github.com/socketio/socket.io)
- [socket.io-msgpack-parser](https://github.com/socketio/socket.io-msgpack-parser)
- [uuid](https://github.com/uuidjs/uuid)
- [wait-queue](https://github.com/flarestart/wait-queue)

## Dev Dependencies

- [eslint](https://github.com/eslint/eslint)
- [nodemon](https://github.com/remy/nodemon)
